# Security Vulnerability Fixes - 2026-02-01

## Overview

Implemented fixes for 9 security vulnerabilities identified in a security audit, ranging from critical SSRF and SQL injection issues to medium-priority password policy and token expiration improvements.

## Implementation Approach

### Priority 1: SSRF Protection (CRITICAL)

Created `UrlValidationService` to prevent Server-Side Request Forgery attacks:
- Validates URLs against RFC 1918 private IP ranges and cloud metadata endpoints
- Resolves hostnames to check all IPs (prevents DNS rebinding attacks)
- Provides safe `fetchContent()` method with redirect validation
- Registered as singleton in AppServiceProvider

Integrated into all external URL fetch points:
- `GeminiProvider::visionQuery()` - Image URL fetching
- `BedrockProvider::visionQuery()` - Image URL fetching
- `WebhookController::store/update/test()` - Webhook URL validation
- `SSOSettingController::test()` - OIDC issuer URL validation

### Priority 2: SQL Injection in Backup Restore (CRITICAL)

Refactored `BackupService` to use JSON format instead of raw SQL:
- New `exportTablesAsJSON()` exports data with integrity hash
- New `restoreDatabaseFromJSON()` uses parameterized queries via `DB::table()->updateOrInsert()`
- Legacy SQL format supported via strict parsing into parameterized queries
- SQLite unchanged (file replacement is safe)

### Priority 3: 2FA Session Flag (HIGH)

Added missing session flag in `TwoFactorController::verify()`:
```php
$request->session()->put('2fa:verified', true);
```

### Priority 4: OAuth State Validation (HIGH)

Enhanced `SSOService` with CSRF protection:
- `getRedirectUrl()` now generates cryptographic state token
- Added `validateStateToken()` with timing-safe comparison
- `SSOController::callback()` validates state before processing

### Priority 5: Webhook Signatures (HIGH)

Added HMAC-SHA256 signature generation to `WebhookController`:
- New `buildWebhookHeaders()` adds timestamp and signature headers
- New `generateSignature()` creates HMAC over `timestamp.payload`
- Headers: `X-Webhook-Timestamp`, `X-Webhook-Signature`

### Priority 6: Password Policy (MEDIUM)

Configured `Password::defaults()` in AppServiceProvider:
- mixedCase, numbers, symbols required
- Compromised password check in production
- Applied to UserController store/update/resetPassword

### Priority 7: Sanctum Token Expiration (MEDIUM)

Changed `config/sanctum.php`:
```php
'expiration' => env('SANCTUM_TOKEN_EXPIRATION', 10080), // 7 days
```

### Priority 9: File Upload Whitelist (LOW)

Enhanced `FileManagerController::upload()`:
- Added default whitelist when none configured
- Added `validateMimeType()` to prevent extension spoofing

## Key Files Modified

### New Files
- `backend/app/Services/UrlValidationService.php`
- `docs/adr/024-security-hardening.md`

### Modified Files
- `backend/app/Providers/AppServiceProvider.php` - UrlValidationService singleton, Password defaults
- `backend/app/Services/LLM/Providers/GeminiProvider.php` - SSRF protection
- `backend/app/Services/LLM/Providers/BedrockProvider.php` - SSRF protection
- `backend/app/Http/Controllers/Api/WebhookController.php` - URL validation, signatures
- `backend/app/Http/Controllers/Api/SSOSettingController.php` - OIDC URL validation
- `backend/app/Http/Controllers/Api/TwoFactorController.php` - 2FA session flag
- `backend/app/Http/Controllers/Api/SSOController.php` - State validation
- `backend/app/Services/Auth/SSOService.php` - State token generation/validation
- `backend/app/Http/Controllers/Api/UserController.php` - Password::defaults()
- `backend/app/Http/Controllers/Api/FileManagerController.php` - File type whitelist, MIME validation
- `backend/config/sanctum.php` - Token expiration
- `backend/app/Services/Backup/BackupService.php` - JSON format, parameterized queries

## Observations

- The UrlValidationService uses PHP's built-in `FILTER_VALIDATE_IP` with `FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE` plus additional manual checks for comprehensive coverage
- Legacy backup SQL format is still readable for backwards compatibility but new backups always use JSON
- Webhook signature format follows industry standards (similar to Stripe, GitHub webhooks)

## Testing Notes

### SSRF Protection
- Create webhook with `http://localhost:8080` - should reject with 422
- Create webhook with `http://169.254.169.254/` - should reject (cloud metadata)
- Test LLM vision query with internal URL - should fail with clear error

### 2FA Verification
- Login with 2FA-enabled user
- Verify protected routes work after 2FA verification
- Verify session contains `2fa:verified` flag

### OAuth State
- Initiate SSO login, tamper with state parameter in callback URL
- Should reject with `invalid_state` error

### Webhook Signatures
- Create webhook with secret
- Test webhook, verify `X-Webhook-Timestamp` and `X-Webhook-Signature` headers present

### Password Policy
- Try creating user with weak password (e.g., "password") - should reject
- Requires: 8+ chars, uppercase, lowercase, number, symbol

### File Upload
- Upload `.exe` file with no file types configured - should reject
- Upload `.jpg` that's actually a `.exe` renamed - MIME validation should reject

## Next Steps

- Add unit tests for UrlValidationService
- Add integration tests for OAuth state validation
- Document webhook signature verification for consumers
- Consider adding CSP headers (separate security hardening item)
