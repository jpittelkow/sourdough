# Sourdough Production Docker Compose
version: '3.8'

services:
  app:
    image: ghcr.io/jpittelkow/sourdough:latest
    container_name: ${CONTAINER_NAME:-sourdough}
    ports:
      - "${APP_PORT:-80}:80"
    volumes:
      # Persist data only (no source code mounts)
      - sourdough_data:/var/www/html/data
      - sourdough_storage:/var/www/html/backend/storage/app
      - sourdough_backups:/var/www/html/backend/storage/app/backups
      - meilisearch_data:/var/lib/meilisearch
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=${APP_URL:-http://localhost}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost}
      - APP_KEY=${APP_KEY}
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/var/www/html/data/database.sqlite
      - CACHE_STORE=file
      - SESSION_DRIVER=file
      - QUEUE_CONNECTION=database
      # Mail (optional)
      - MAIL_MAILER=${MAIL_MAILER:-log}
      - MAIL_HOST=${MAIL_HOST:-}
      - MAIL_PORT=${MAIL_PORT:-}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      - MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS:-}
      # SSO Providers (optional)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      # AI Providers (optional)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      # Meilisearch (search, runs inside container)
      - MEILISEARCH_HOST=http://127.0.0.1:7700
      - MEILISEARCH_KEY=${MEILI_MASTER_KEY}
      - MEILI_ENV=production
      - MEILI_MASTER_KEY=${MEILI_MASTER_KEY}
      - SCOUT_DRIVER=meilisearch
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  sourdough_data:
    driver: local
  sourdough_storage:
    driver: local
  sourdough_backups:
    driver: local
  meilisearch_data:
    driver: local