[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info

[program:meilisearch]
# Use su to properly set up user environment (HOME, etc.) - supervisor's user= directive
# only does setuid() without setting HOME, causing "Permission denied" errors when
# meilisearch tries to access $HOME/.local/ while HOME is still /root
command=/bin/sh -c "exec su -s /bin/sh www-data -c 'HOME=/var/lib/meilisearch /usr/local/bin/meilisearch --db-path /var/lib/meilisearch/data --http-addr 127.0.0.1:7700 --env %(ENV_MEILI_ENV)s --master-key %(ENV_MEILI_MASTER_KEY)s'"
autostart=true
autorestart=true
priority=1
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
priority=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:php-fpm]
command=/usr/local/sbin/php-fpm -F
autostart=true
autorestart=true
priority=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:laravel-queue]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/html/backend/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue.log
stopwaitsecs=3600

[program:laravel-scheduler]
command=/bin/sh -c "while [ true ]; do php /var/www/html/backend/artisan schedule:run --verbose --no-interaction; sleep 60; done"
autostart=true
autorestart=true
user=www-data
redirect_stderr=true
stdout_logfile=/var/log/supervisor/scheduler.log

[program:nextjs]
# Fix .next permissions as root, then switch to www-data to run Next.js
# This prevents EACCES errors when root-owned files exist in the volume
command=/bin/sh -c "chown -R www-data:www-data /var/www/html/frontend/.next 2>/dev/null; exec su -s /bin/sh www-data -c 'PORT=3000 /bin/sh /start-nextjs.sh'"
directory=/var/www/html/frontend
autostart=true
autorestart=true
environment=PORT="3000"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

[program:search-reindex]
# Wait for Meilisearch to be ready, then reindex search data
# Runs once at startup (autorestart=false) - migrations ran with SCOUT_DRIVER=null
command=/bin/sh -c "echo 'Waiting for Meilisearch...'; until curl -sf http://127.0.0.1:7700/health >/dev/null 2>&1; do sleep 2; done; echo 'Meilisearch ready, reindexing...'; php /var/www/html/backend/artisan search:reindex; echo 'Search reindex complete'"
autostart=true
autorestart=false
startsecs=0
user=www-data
priority=20
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
