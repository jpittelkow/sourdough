---
description: Standard commands for local Docker development environment
alwaysApply: true
---

# Local Docker Development

Standard commands and procedures for running Sourdough locally via Docker.

## Starting the Development Environment

**Always use these exact commands:**

```bash
# First time setup (copy env file)
cp .env.example .env

# Start the container (builds if needed)
docker-compose up -d

# Access at http://localhost:8080
```

**Do NOT use `docker run` directly** - always use `docker-compose`.

## Common Operations

### Start/Stop Container

```bash
# Start (detached)
docker-compose up -d

# Stop
docker-compose down

# Stop and remove volumes (CAUTION: loses data)
docker-compose down -v
```

### Rebuild After Changes

**When to rebuild:**
- Changes to `docker/Dockerfile`
- Changes to `docker-compose.yml`
- Changes to `docker/*.conf` files
- Changes to `docker/*.sh` scripts
- Dependency changes (`composer.json`, `package.json`)

```bash
# Rebuild and restart
docker-compose up -d --build

# Force full rebuild (no cache)
docker-compose build --no-cache && docker-compose up -d
```

### View Logs

```bash
# All logs (follow)
docker-compose logs -f

# Last 100 lines
docker-compose logs --tail=100

# Specific service logs
docker-compose logs -f app
```

### Access Container Shell

```bash
# Bash shell
docker-compose exec app bash

# Run artisan command
docker-compose exec app php /var/www/html/backend/artisan migrate

# Run npm command
docker-compose exec app npm --prefix /var/www/html/frontend run build
```

## Environment Configuration

### Port Configuration

Default port is `8080`. To change, edit `.env`:

```env
APP_PORT=8081
```

### Container Name

Default is `sourdough-dev`. To change (useful for multiple instances):

```env
CONTAINER_NAME=sourdough-myproject
```

## Troubleshooting

### Container Won't Start

1. Check logs: `docker-compose logs`
2. Check port conflicts: `docker ps` or `netstat -an | findstr 8080`
3. Try rebuild: `docker-compose up -d --build`

### Database Issues

```bash
# Reset database (CAUTION: loses data)
docker-compose down -v
docker-compose up -d
```

### Frontend Build Issues

```bash
# Clear frontend volumes and rebuild
docker-compose down
docker volume rm sourdough_frontend_node_modules sourdough_frontend_next_cache 2>/dev/null || true
docker-compose up -d --build
```

### Permission Issues

The entrypoint script handles permissions. If issues persist:

```bash
docker-compose exec app chown -R www-data:www-data /var/www/html/backend/storage
docker-compose exec app chown -R www-data:www-data /var/www/html/frontend/.next
```

### Changes Not Being Picked Up

If file changes aren't reflected:

1. **Backend (PHP):** Restart container to apply new `php-dev.ini`:
   ```bash
   docker-compose restart
   ```

2. **Frontend - clear Next.js cache:** The `.next` cache volume may have stale builds:
   ```bash
   docker-compose down
   docker volume rm sourdough_frontend_next_cache 2>/dev/null || true
   docker-compose up -d
   ```

3. **Verify development mode:** Check logs for "development mode":
   ```bash
   docker-compose logs | grep -i "development"
   ```

4. **Verify polling is enabled:** Check Next.js logs show webpack polling:
   ```bash
   docker-compose logs | grep -i "watching"
   ```

**Note:** Webpack polling and `WATCHPACK_POLLING=true` are already configured for Windows compatibility. If changes still aren't detected, clearing the Next.js cache volume (step 2) should resolve it.

## Volume Mounts

The development setup uses these volumes:

| Volume | Purpose |
|--------|---------|
| `./backend` | Backend source (live reload) |
| `./frontend` | Frontend source (live reload) |
| `frontend_node_modules` | Node modules (isolated) |
| `frontend_next_cache` | Next.js build cache (isolated) |
| `sourdough_data` | SQLite database |
| `sourdough_storage` | Laravel storage |

**Note:** Named volumes (`frontend_node_modules`, `frontend_next_cache`) isolate container dependencies from host, preventing conflicts.

## Hot Reload / File Change Detection

**Backend (PHP/Laravel):**
- Source is mounted at `./backend:/var/www/html/backend`
- Development uses `docker/php-dev.ini` with `opcache.validate_timestamps=1`
- PHP detects file changes immediately without restart

**Frontend (Next.js):**
- Source is mounted at `./frontend:/var/www/html/frontend`
- Runs in development mode with `npm run dev` and hot module replacement
- Uses webpack polling (configured in `next.config.js`) for reliable change detection
- `WATCHPACK_POLLING=true` environment variable enables watchpack polling mode

### Windows File Watching

Docker on Windows (via WSL2/Hyper-V) doesn't reliably propagate filesystem events (`inotify`) to containers. The project uses **polling** instead:

1. **Webpack polling** in `frontend/next.config.js` - Checks for changes every 1 second
2. **WATCHPACK_POLLING=true** in `docker-compose.yml` - Enables watchpack polling

This ensures file changes are detected regardless of the host OS.

## Key Files

- `docker-compose.yml` - Development compose configuration
- `docker-compose.prod.yml` - Production compose configuration
- `docker/Dockerfile` - Container image definition
- `docker/entrypoint.sh` - Container startup script
- `docker/supervisord.conf` - Process management
- `docker/nginx.conf` - Web server configuration
- `docker/php.ini` - PHP config (production)
- `docker/php-dev.ini` - PHP config (development, mounted in docker-compose.yml)
- `.env` - Local environment variables (not committed)
- `.env.example` - Environment template

## Do NOT

- Use `docker run` directly (use `docker-compose`)
- Edit files inside running container (edit on host, auto-synced)
- Manually create database (entrypoint handles it)
- Skip `--build` flag after Dockerfile changes
